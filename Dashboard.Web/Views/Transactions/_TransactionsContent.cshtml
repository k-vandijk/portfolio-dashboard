@inject IStringLocalizer<SharedResource> SharedLocalizer
@model List<Dashboard.Domain.Models.Transaction>
@{
    var uniqueTickers = Model
        .Select(t => t.Ticker.Trim())
        .Where(t => !string.IsNullOrWhiteSpace(t))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(t => t)
        .ToList();
}

<style>
    /* Make all table cells vertically centered (override Bootstrap's default 'top') */
    #transactionsTable > :not(caption) > * > * {
        vertical-align: middle;
    }

    /* Center-align the first and last columns (header + body) */
    #transactionsTable thead th:first-child,
    #transactionsTable tbody td:first-child,
    #transactionsTable thead th:last-child,
    #transactionsTable tbody td:last-child {
        text-align: center;
    }

    /* Keep the last column compact and prevent wrapping */
    #transactionsTable thead th:last-child,
    #transactionsTable tbody td:last-child {
        white-space: nowrap;
        width: 1%;
    }

        /* Ensure the delete button/icon is perfectly centered */
        #transactionsTable tbody td:last-child .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Optional: normalize icon alignment in first column */
        #transactionsTable tbody td:first-child i,
        #transactionsTable thead th:last-child i {
            line-height: 1;
            vertical-align: middle;
        }




    /* Scope to this table's generated wrapper */
    #transactionsTable_wrapper .dataTables_paginate {
        display: flex;
        align-items: center;
        gap: .25rem;
        margin-top: .5rem;
    }

        /* Base button look */
        #transactionsTable_wrapper .dataTables_paginate .paginate_button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2rem;
            height: 2rem;
            padding: 0 .5rem;
            border: 1px solid var(--bs-border-color, #dee2e6);
            border-radius: .5rem;
            background: transparent;
            color: var(--bs-body-color, #212529) !important;
            font-size: .875rem;
            line-height: 1;
            text-decoration: none !important;
            transition: background-color .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease, filter .15s ease;
            cursor: pointer;
        }

            /* Hover */
            #transactionsTable_wrapper .dataTables_paginate .paginate_button:hover {
                background: var(--bs-light, #f8f9fa);
                border-color: var(--bs-border-color, #dee2e6);
            }

            /* Active (current page) */
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.current,
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.current:hover {
                background: var(--accent-1, #0d6efd);
                border-color: var(--accent-1, #0d6efd);
                color: #fff !important;
            }

            /* Disabled (e.g., prev/next at ends) */
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.disabled,
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.disabled:hover {
                opacity: .45;
                background: transparent;
                color: var(--bs-secondary-color, #6c757d) !important;
                cursor: not-allowed;
            }

            /* Prev/Next buttons */
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.previous,
            #transactionsTable_wrapper .dataTables_paginate .paginate_button.next {
                padding: 0 .6rem;
            }

        /* Ellipsis (…) */
        #transactionsTable_wrapper .dataTables_paginate .ellipsis {
            padding: 0 .4rem;
            opacity: .6;
        }

</style>

<datalist id="tickerList">
    @foreach (var t in uniqueTickers)
    {
        <option value="@t"></option>
    }
</datalist>

<div class="row mb-3" style="height: 95vh;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive h-100">
                    <table id="transactionsTable" class="table table-hover table-sm table-transparent mb-0 w-100">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>@SharedLocalizer["Date"]</th>
                            <th>@SharedLocalizer["Ticker"]</th>
                            <th>@SharedLocalizer["Amount"]</th>
                            <th>@SharedLocalizer["PurchasePrice"]</th>
                            <th>@SharedLocalizer["TransactionCosts"]</th>
                            <th>@SharedLocalizer["TotalCosts"]</th>
                            <th class="text-center"><i class="fas fa-trash-alt"></i></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="text-center align-middle"><i class="fas fa-plus text-success"></i></td>
                            <td><input class="form-control form-control-sm" id="dateInput" type="text" /></td>
                            <td><input class="form-control form-control-sm" id="tickerInput" list="tickerList" autocomplete="off" /></td>
                            <td><input class="form-control form-control-sm" id="amountInput" /></td>
                            <td><input class="form-control form-control-sm" id="purchasePriceInput" /></td>
                            <td><input class="form-control form-control-sm" id="transactionCostsInput" /></td>
                            <td><input class="form-control form-control-sm" id="totalCostsInput" readonly /></td>
                            <td></td>
                        </tr>
                        @for (int i = Model.Count - 1; i >= 0; i--)
                        {
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@Model[i].Date.ToString("yyyy-MM-dd")</td>
                                <td>@Model[i].Ticker</td>
                                <td class="text-end">@Model[i].Amount</td>
                                <td class="text-end">@Model[i].PurchasePrice.ToString("C2")</td>
                                <td class="text-end">@Model[i].TransactionCosts.ToString("C2")</td>
                                <td class="text-end fw-bold">
                                    <span class="@(Model[i].TotalCosts >= 0 ? "text-success" : "text-danger")">
                                        @Model[i].TotalCosts.ToString("C2")
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-outline-danger btn-sm rounded-circle p-0 d-flex align-items-center justify-content-center"
                                            style="width: 1rem; height: 1rem;"
                                            onclick="postDeleteTransaction('@Model[i].RowKey')">
                                        <i class="fas fa-minus fa-xs"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        $('#transactionsTable').DataTable({
            paging: true,
            searching: false,
            ordering: false,
            pageLength: 20,
            lengthChange: false,
            order: [[0, 'desc']],
            pagingType: 'simple_numbers',
            language: {
            paginate: {
                    previous: '<i class="fa-solid fa-angle-left" aria-hidden="true"></i>',
                    next:     '<i class="fa-solid fa-angle-right" aria-hidden="true"></i>'
                }
            }
        });

        // Set event listeners on the number inputs to update the totals
        ['amountInput', 'purchasePriceInput', 'transactionCostsInput'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('keyup', calcTotal);
        });

        // Set event listeners on all inputs (except the totalCostsInput) to listen for 'enter' to post the data
        ['tickerInput', 'amountInput', 'purchasePriceInput', 'transactionCostsInput', 'totalCostsInput']
            .forEach(id => {
                document.getElementById(id).addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const entity = buildEntity();

                        postAddTransaction(entity);
                    }
                });
            });

        flatpickr("#dateInput", {
            dateFormat: "Y-m-d",
            allowInput: true,
            clickOpens: true,
            disableMobile: true,
        });
    });

    function calcTotal() {
        const amount = parseDecimal(document.getElementById('amountInput').value) || 0;
        const price = parseDecimal(document.getElementById('purchasePriceInput').value) || 0;
        const costs = parseDecimal(document.getElementById('transactionCostsInput').value) || 0;

        const total = amount * price + costs;
        document.getElementById('totalCostsInput').value = total.toLocaleString('nl-NL', {
            style: 'currency',
            currency: 'EUR'
        });
        return total;
    }

    function buildEntity() {
        const entity = {
            Date: document.getElementById('dateInput').value || null,
            Ticker: (document.getElementById('tickerInput').value || '').trim() || null,
            Amount: parseDecimal(document.getElementById('amountInput').value) || 0,
            PurchasePrice: parseDecimal(document.getElementById('purchasePriceInput').value) || 0,
            TransactionCosts: parseDecimal(document.getElementById('transactionCostsInput').value) || 0,
        };

        return entity;
    }

    function clearInputs() {
        ['dateInput','tickerInput','amountInput','purchasePriceInput','transactionCostsInput','totalCostsInput']
            .forEach(id => document.getElementById(id).value = '');
    }

    function parseDecimal(value) {
        return parseFloat(value.replace(',', '.'));
    }

    function postAddTransaction(transaction) {
        fetch('@Url.Action("AddTransaction", "Transactions")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transaction)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }

            clearInputs();
            location.reload();
        })
        .catch(error => {
            showAlert('error', 'Error adding transaction.');
        });
    }

    function postDeleteTransaction(rowKey) {
        showConfirmationDialog('Are you sure you want to delete this transaction?', function() {
            fetch('@Url.Action("DeleteTransaction", "Transactions")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rowKey)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }

                location.reload();
            })
            .catch(error => {
                showAlert('error', 'Error deleting transaction.');
            });
        });
    }
</script>