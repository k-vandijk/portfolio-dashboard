@model List<Dashboard.Domain.Models.Transaction>
@{
    ViewData["Title"] = "Transactions";

    var uniqueTickers = Model
        .Select(t => t.Ticker.Trim())
        .Where(t => !string.IsNullOrWhiteSpace(t))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(t => t)
        .ToList();
}

<datalist id="tickerList">
    @foreach (var t in uniqueTickers)
    {
        <option value="@t"></option>
    }
</datalist>

<div class="row mb-3" style="height: 95vh;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive h-100">
                    <table id="transactionsTable" class="table table-hover table-sm mb-0 w-100">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Ticker</th>
                            <th>Amount</th>
                            <th>Purchase price</th>
                            <th>Transaction costs</th>
                            <th>Total costs</th>
                            <th class="text-center"><i class="fas fa-trash-alt"></i></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="table-light">
                            <td class="text-center align-middle"><i class="fas fa-plus text-success"></i></td>
                            <td><input class="form-control form-control-sm" id="dateInput" /></td>
                            <td><input class="form-control form-control-sm" id="tickerInput" list="tickerList" autocomplete="off" /></td>
                            <td><input class="form-control form-control-sm" id="amountInput" /></td>
                            <td><input class="form-control form-control-sm" id="purchasePriceInput" /></td>
                            <td><input class="form-control form-control-sm" id="transactionCostsInput" /></td>
                            <td><input class="form-control form-control-sm" id="totalCostsInput" readonly /></td>
                            <td></td>
                        </tr>
                        @for (int i = Model.Count - 1; i >= 0; i--)
                        {
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@Model[i].Date.ToString("yyyy-MM-dd")</td>
                                <td>@Model[i].Ticker</td>
                                <td class="text-end">@Model[i].Amount</td>
                                <td class="text-end">@Model[i].PurchasePrice.ToString("C2")</td>
                                <td class="text-end">@Model[i].TransactionCosts.ToString("C2")</td>
                                <td class="text-end fw-bold">
                                    <span class="@(Model[i].TotalCosts >= 0 ? "text-success" : "text-danger")">
                                        @Model[i].TotalCosts.ToString("C2")
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-outline-danger btn-sm rounded-circle p-0 d-flex align-items-center justify-content-center"
                                            style="width: 1rem; height: 1rem;"
                                            onclick="postDeleteTransaction('@Model[i].RowKey')">
                                        <i class="fas fa-minus fa-xs"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // Initialize the datatable
            $('#transactionsTable').DataTable({
                "paging": true,
                "searching": false,
                "ordering": false,
                "pageLength": 16,
                "lengthChange": false,
                "order": [[0, 'desc']]
            });

            // Set event listeners on the number inputs to update the totals
            ['amountInput', 'purchasePriceInput', 'transactionCostsInput'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('keyup', calcTotal);
            });

            // Set event listeners on all inputs (except the totalCostsInput) to listen for 'enter' to post the data
            ['dateInput', 'tickerInput', 'amountInput', 'purchasePriceInput', 'transactionCostsInput', 'totalCostsInput']
                .forEach(id => {
                    document.getElementById(id).addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const entity = buildEntity();

                            postAddTransaction(entity);
                        }
                    });
                });
        });

        function calcTotal() {
            const amount = parseDecimal(document.getElementById('amountInput').value) || 0;
            const price = parseDecimal(document.getElementById('purchasePriceInput').value) || 0;
            const costs = parseDecimal(document.getElementById('transactionCostsInput').value) || 0;

            const total = amount * price + costs;
            document.getElementById('totalCostsInput').value = total.toLocaleString('nl-NL', {
                style: 'currency',
                currency: 'EUR'
            });
            return total;
        }

        function buildEntity() {
            const entity = {
                Date: document.getElementById('dateInput').value || null,
                Ticker: (document.getElementById('tickerInput').value || '').trim() || null,
                Amount: parseDecimal(document.getElementById('amountInput').value) || 0,
                PurchasePrice: parseDecimal(document.getElementById('purchasePriceInput').value) || 0,
                TransactionCosts: parseDecimal(document.getElementById('transactionCostsInput').value) || 0,
            };

            return entity;
        }

        function clearInputs() {
            ['dateInput','tickerInput','amountInput','purchasePriceInput','transactionCostsInput','totalCostsInput']
                .forEach(id => document.getElementById(id).value = '');
        }

        function parseDecimal(value) {
            return parseFloat(value.replace(',', '.'));
        }

        function postAddTransaction(transaction) {
            fetch('/Transactions/AddTransaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(transaction)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }

                clearInputs();
                location.reload();
            })
            .catch(error => {
                console.error('Error adding transaction:', error);
            });
        }

        function postDeleteTransaction(rowKey) {
            if (!confirm("Are you sure you want to delete this transaction?")) {
                return;
            }

            fetch('/Transactions/DeleteTransaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rowKey)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }

                location.reload();
            })
            .catch(error => {
                console.error('Error deleting transaction:', error);
            });
        }
    </script>
}
