@using System.Globalization
@using Dashboard.Domain.Utils
@using Microsoft.AspNetCore.Mvc.TagHelpers
@inject IStringLocalizer<SharedResource> SharedLocalizer
@functions {
    public bool IsActive(string controllerName)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        return string.Equals(currentController, controllerName, StringComparison.OrdinalIgnoreCase);
    }
}

@{
    // Bepaal huidige UI-cultuur en bouw de select-items (geen inline C# in <option>)
    var currentCulture = CultureInfo.CurrentUICulture.Name;
    var cultureItems = new List<SelectListItem>
    {
        new SelectListItem { Value = "nl-NL", Text = "🇳🇱  Nederlands", Selected = currentCulture == "nl-NL" },
        new SelectListItem { Value = "en-US", Text = "🇺🇸  English",    Selected = currentCulture == "en-US" }
    };

    bool isCollapsed = Context.Request.Cookies[StaticDetails.SidebarStateCookie] == "true";
}

<style>

    #sidebar {
        width: 250px;
        transition: width .25s ease;
        height: 100vh;
    }

        #sidebar.collapsed {
            width: 56px; /* slim */
            padding-left: .5rem !important;
            padding-right: .5rem !important;
            padding-top: 2.75rem !important; /* space between caret and first icon */
        }

    /* Toggle button */
    #toggleSidebar {
        position: absolute;
        top: .5rem;
        right: .5rem; /* default: align right when expanded */
        background: transparent;
        border: 0;
        padding: .25rem;
        line-height: 1;
        cursor: pointer;
    }

        #toggleSidebar i {
            transition: transform .25s ease;
        }

    /* Flip the double-caret when collapsed */
    #sidebar.collapsed #toggleSidebar i {
        transform: rotate(180deg);
    }

    /* Keep text from wrapping in expanded state */
    #sidebar .brand,
    #sidebar .brand-text,
    #sidebar .link-text {
        white-space: nowrap;
    }

    /* Base link layout (expanded) */
    #sidebar .nav-link {
        display: flex;
        align-items: center;
    }

        #sidebar .nav-link i {
            margin-right: .5rem;
            color: inherit; /* follow link color by default */
        }



    /* Hide brand and divider when collapsed (but keep the nav visible) */
    #sidebar.collapsed .brand,
    #sidebar.collapsed hr {
        display: none !important;
    }

    /* Hide only the text; keep the icons visible */
    #sidebar.collapsed .brand-text,
    #sidebar.collapsed .link-text {
        display: none !important;
    }

    /* Center icons inside the narrow sidebar */
    #sidebar.collapsed .nav-link {
        justify-content: center;
        padding-left: .5rem;
        padding-right: .5rem;
    }

        /* No gap next to icons when text is hidden */
        #sidebar.collapsed .nav-link i {
            margin-right: 0;
        }

    /* Center the toggle horizontally when collapsed */
    #sidebar.collapsed #toggleSidebar {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
    }

    /* Extra breathing room between the caret and the first icon */
    #sidebar.collapsed .nav {
        margin-top: .5rem; /* tweak to taste */
    }

    /* Do NOT highlight the active tab (no pill background) when collapsed */
    #sidebar.collapsed .nav-pills .nav-link.active,
    #sidebar.collapsed .nav-pills .nav-link.active:focus,
    #sidebar.collapsed .nav-pills .nav-link.active:hover {
        background-color: transparent !important;
        color: var(--bs-body-color) !important; /* keep link color neutral */
        box-shadow: none;
    }

        /* In collapsed state, color ONLY the active icon */
        #sidebar.collapsed .nav-pills .nav-link.active i {
            color: var(--accent-1) !important;
        }

    /* (Optional) subtle hover cue when collapsed */
    #sidebar.collapsed .nav-link:hover {
        color: var(--accent-1) !important;
    }

    #sidebar .language-selector {
        margin-top: auto;
    }

    /* Verberg de language selector als de sidebar collapsed is */
    #sidebar.collapsed .language-selector {
        display: none !important;
    }

</style>

<aside id="sidebar" class="p-3 position-relative d-flex flex-column @(isCollapsed ? "collapsed" : "")">
    <button id="toggleSidebar" aria-label="Toggle sidebar" aria-controls="sidebar" aria-expanded="true" class="text-secondary">
        <i class="fa-solid fa-angles-left"></i>
    </button>

    <a class="brand d-flex align-items-center mb-3 text-decoration-none fw-bold fs-5" style="color: var(--accent-1);">
        <span class="brand-text">Kevin van Dijk</span>
    </a>
    <hr>

    <ul class="nav nav-pills flex-column">
        
        <li class="nav-item mb-2">
            <a asp-controller="Dashboard" asp-action="Index" class="nav-link @(IsActive("Dashboard") ? "active" : "")">
                <i class="fas fa-tachometer-alt me-2"></i>
                <span class="link-text">@SharedLocalizer["Dashboard"]</span>
            </a>
        </li>
        <li class="nav-item mb-2">
            <a asp-controller="Investment" asp-action="Index" class="nav-link @(IsActive("Investment") ? "active" : "")">
                <i class="fas fa-chart-line me-2"></i>
                <span class="link-text">@SharedLocalizer["Investment"]</span>
            </a>
        </li>
        <li class="nav-item">
            <a asp-controller="MarketHistory" asp-action="Index" class="nav-link @(IsActive("MarketHistory") ? "active" : "")">
                <i class="fas fa-clock-rotate-left me-2"></i>
                <span class="link-text">@SharedLocalizer["MarketHistory"]</span>
            </a>
        </li>
        <li class="nav-item">
            <a asp-controller="Transactions" asp-action="Index" class="nav-link @(IsActive("Transactions") ? "active" : "")">
                <i class="fas fa-receipt me-2"></i>
                <span class="link-text">@SharedLocalizer["Transactions"]</span>
            </a>
        </li>
    </ul>
    
    <div class="mt-auto pt-3 language-selector">
        <div class="label">@SharedLocalizer["Language"]</div>
        <form asp-controller="Sidebar" asp-action="SetCulture" method="post" id="cultureSelectionForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
            <select id="uiLang" name="culture" class="form-select form-select-sm rounded-pill border-0" asp-items="cultureItems" aria-label="Language"></select>
        </form>
    </div>

</aside>

<script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');

    toggleBtn.addEventListener('click', async () => {
        const collapsed = sidebar.classList.toggle('collapsed');
        toggleBtn.setAttribute('aria-expanded', String(!collapsed));

        const formData = new FormData();
        formData.set('collapsed', String(collapsed));

        const url = '@Url.Action("ToggleSidebarCollapsedState", "Sidebar")';
        await fetch(url, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });
    });

    document.getElementById('cultureSelectionForm').addEventListener('change', function () {
        document.getElementById('cultureSelectionForm').submit();
    });
</script>