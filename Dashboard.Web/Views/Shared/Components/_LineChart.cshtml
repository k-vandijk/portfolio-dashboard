@model Dashboard.Web.ViewModels.LineChartViewModel
@{
    var chartId = (string?)ViewData["ChartId"] ?? "chart_" + Guid.NewGuid().ToString("N");
}

<style>
    /* Ensure the parent container defines its own height (flex or px/vh based) */
    .chart-container {
        position: relative;
        width: 100%;
        height: 100%; /* Fill parent’s height */
    }

    .chart-container > .chart-canvas {
        position: absolute;
        inset: 0;
        width: 100% !important;
        height: 100% !important; /* Force the canvas to fill container height */
    }
</style>

<div class="card">
    @if (!string.IsNullOrEmpty(Model.Title))
    {
        <div class="card-header d-flex gap-1">
            @Model.Title

            @if (Model.Profit.HasValue)
            {
                var profit = Model.Profit.Value;
                var cssClass = profit >= 0 ? "text-success" : "text-danger";

                <span class="@cssClass fw-bold small">
                    (@profit.ToString("C2"))
                </span>
            }
        </div>
    }
    <div class="card-body">
        <div class="chart-container">
            <canvas id="@chartId" class="chart-canvas"></canvas>
        </div>
    </div>
</div>

<script>
    function init() {
        const element = document.getElementById('@chartId');
        if (!element) return;

        // Chart data
        const chartData = @Html.Raw(JsonSerializer.Serialize(new {
            labels   = Model.DataPoints.Select(dp => dp.Label),
            datasets = new[] {
                new {
                    label = Model.Title,
                    data = Model.DataPoints.Select(dp => dp.Value),
                    tension = 0.45,
                    fill = true,
                    pointRadius = 0,
                    pointHoverRadius = 3,
                    hitRadius = 8
                }
            }
        }));

        chartData.datasets[0].borderColor = accentColors[0];
        chartData.datasets[0].backgroundColor = accentColors[0] + "33";

        // Formatting from ViewModel
        const yFormat = @Html.Raw(JsonSerializer.Serialize(Model.Format)); // "currency" | "percentage" | "number"

        const fmtCurrency = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtNumber = new Intl.NumberFormat('nl-NL', { maximumFractionDigits: 2 });

        function formatY(v) {
            if (yFormat === 'currency') return fmtCurrency.format(v);
            if (yFormat === 'percentage') return fmtNumber.format(v) + '%';
            return fmtNumber.format(v);
        }

        new Chart(element, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (ctx) => formatY(ctx.parsed.y) }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 12 } },
                    y: {
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 6,
                            callback: (value) => formatY(value)
                        }
                    }
                }
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>