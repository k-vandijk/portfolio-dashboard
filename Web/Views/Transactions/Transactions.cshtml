@model List<Transaction>
@{
    ViewData["Title"] = "Transactions";

    string todayString = DateTime.Today.ToString("yyyy-MM-dd");

    var uniqueTickers = Model
        .Select(t => t.Ticker.Trim())
        .Where(t => !string.IsNullOrWhiteSpace(t))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(t => t)
        .ToList();
}

<datalist id="tickerList">
    @foreach (var t in uniqueTickers)
    {
        <option value="@t"></option>
    }
</datalist>

<div class="row mb-3" style="height: 95vh;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive h-100">
                    <table id="transactionsTable" class="table table-hover table-sm mb-0 w-100">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Ticker</th>
                            <th>Amount</th>
                            <th>PurchasePrice</th>
                            <th>TransactionCosts</th>
                            <th>TotalCosts</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td></td>
                            <td><input class="form-control" id="dateInput" value="@todayString" /></td>
                            <td><input class="form-control" id="tickerInput" list="tickerList" autocomplete="off" /></td>
                            <td><input class="form-control" id="amountInput" /></td>
                            <td><input class="form-control" id="purchasePriceInput" /></td>
                            <td><input class="form-control" id="transactionCostsInput" /></td>
                            <td><input class="form-control" id="totalCostsInput" readonly /></td>
                        </tr>
                        @for (int i = Model.Count - 1; i >= 0; i--)
                        {
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@Model[i].Date.ToString("yyyy-MM-dd")</td>
                                <td>@Model[i].Ticker</td>
                                <td>@Model[i].Amount</td>
                                <td>@Model[i].PurchasePrice.ToString("C2", System.Globalization.CultureInfo.GetCultureInfo("nl-NL"))</td>
                                <td>@Model[i].TransactionCosts.ToString("C2", System.Globalization.CultureInfo.GetCultureInfo("nl-NL"))</td>
                                <td>@Model[i].TotalCosts.ToString("C2", System.Globalization.CultureInfo.GetCultureInfo("nl-NL"))</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // Initialize the datatable
            $('#transactionsTable').DataTable({
                "paging": true,
                "searching": false,
                "ordering": false,
                "pageLength": 16,
                "lengthChange": false,
                "order": [[0, 'desc']]
            });

            // Set event listeners on the number inputs to update the totals
            ['amountInput', 'purchasePriceInput', 'transactionCostsInput'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('keyup', calcTotal);
            });

            // Set event listeners on all inputs (except the totalCostsInput) to listen for 'enter' to post the data
            ['dateInput','tickerInput','amountInput','purchasePriceInput','transactionCostsInput']
                .forEach(id => {
                    document.getElementById(id).addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const entity = buildEntity();

                            console.log('Transaction entity:', entity);

                            clearInputs();
                            document.getElementById('dateInput').focus();
                        }
                    });
                });
        });

        function calcTotal() {
            const amount = parseFloat(document.getElementById('amountInput').value.replace(',', '.')) || 0;
            const price = parseFloat(document.getElementById('purchasePriceInput').value.replace(',', '.')) || 0;
            const costs = parseFloat(document.getElementById('transactionCostsInput').value.replace(',', '.')) || 0;

            const total = amount * price + costs;
            document.getElementById('totalCostsInput').value = total.toLocaleString('nl-NL', {
                style: 'currency',
                currency: 'EUR'
            });
            return total;
        }

        function buildEntity() {
            const entity = {
                Date: document.getElementById('dateInput').value || null,
                Ticker: (document.getElementById('tickerInput').value || '').trim() || null,
                Amount: document.getElementById('amountInput').value || '0',
                PurchasePrice: document.getElementById('purchasePriceInput').value || '0',
                TransactionCosts: document.getElementById('transactionCostsInput').value || '0',
                TotalCosts: document.getElementById('totalCostsInput').value || '0'
            };

            return entity;
        }

        function clearInputs() {
            ['dateInput','tickerInput','amountInput','purchasePriceInput','transactionCostsInput','totalCostsInput']
                .forEach(id => document.getElementById(id).value = '');

            document.getElementById('dateInput').value = '@todayString';
        }
    </script>
}
