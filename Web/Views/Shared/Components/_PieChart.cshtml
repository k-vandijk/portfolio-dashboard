@model Dashboard.Web.ViewModels.PieChartViewModel
@{
    var chartId = (string?)ViewData["ChartId"] ?? "chart_" + Guid.NewGuid().ToString("N");
}

<div class="card">
    @if (!string.IsNullOrEmpty(Model.Title))
    {
        <div class="card-header">@Model.Title</div>
    }
    <div class="card-body">
        <canvas id="@chartId" class="chart-canvas"></canvas>
    </div>
</div>

<script>
    function init() {
        var element = document.getElementById('@chartId');
        if (!element) return;

        // Chart data serializeren
        const chartData = @Html.Raw(JsonSerializer.Serialize(new {
            labels = Model.Data.Select(dp => dp.Label),
            datasets = new[] {
                new {
                    data = Model.Data.Select(dp => dp.Value),
                    borderWidth = 3
                }
            }
        }));

        const total = chartData.datasets[0].data.reduce((a, b) => a + b, 0);

        // Css variables ophalen
        chartData.datasets[0].backgroundColor = accentColors;

        // Formatting from ViewModel
        const yFormat = @Html.Raw(JsonSerializer.Serialize(Model.Format)); // "currency" | "percentage" | "number"

        const fmtCurrency = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtNumber = new Intl.NumberFormat('nl-NL', { maximumFractionDigits: 2 });

        function formatY(v) {
            if (yFormat === 'currency') return fmtCurrency.format(v);
            if (yFormat === 'percentage') return fmtNumber.format(v) + '%';
            return fmtNumber.format(v);
        }

        // Chart initialiseren
        new Chart(element, {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const value = ctx.parsed;
                                const pct = total > 0 ? (value / total * 100) : 0;
                                return `${formatY(value)} (${fmtNumber.format(pct)}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

</script>