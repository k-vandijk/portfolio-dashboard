@inject IStringLocalizer<SharedResource> SharedLocalizer
@model InvestmentViewModel

@{
    var currentTickersString =
        Context.Request.Query.TryGetValue("tickers", out var tickersVal) && !string.IsNullOrWhiteSpace(tickersVal)
            ? tickersVal.ToString()
            : null;

    var currentTickers = currentTickersString?.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries) ?? Array.Empty<string>();

    var currentYear = Context.Request.Query.TryGetValue("year", out var yearVal) && !string.IsNullOrWhiteSpace(yearVal)
        ? int.Parse(yearVal!)
        : DateTime.Now.Year;

    var selectAll = currentTickers.Length == 0;
    var selectedTickers = selectAll ? Model.Tickers : currentTickers;

    var filtersViewModel = new InvestmentFiltersContentViewModel
    {
        SharedLocalizer = SharedLocalizer,
        Tickers = Model.Tickers,
        Years = Model.Years,
        CurrentTickersString = currentTickersString,
        CurrentYear = currentYear,
        SelectedTickers = selectedTickers,
        PieChartLabels = Model.PieChart.Data.Select(dp => dp.Label).ToHashSet(StringComparer.OrdinalIgnoreCase),
        SystemUrlInvestment = SharedLocalizer["SystemUrl_Investment"]
    };

    var mobileFabViewModel = new MobileFilterFabDropdownViewModel
    {
        ButtonId = "investmentFiltersFab",
        AriaLabel = SharedLocalizer["Filters"],
        ContentPartial = "_InvestmentFiltersContent",
        ContentModel = filtersViewModel
    };
}

@await Html.PartialAsync("Components/_MobileFilterFabDropdown", mobileFabViewModel)

<div class="row h-47vh">

    <div class="col-12 col-xs-12 col-md-12 col-lg-6 col-xl-6 mb-3 d-none d-md-block">
        <div class="card">
            <div class="card-body d-flex flex-column justify-content-evenly">
                @await Html.PartialAsync("_InvestmentFiltersContent", filtersViewModel)
            </div>
        </div>
    </div>

    <div class="col-12 col-xs-12 col-md-12 col-lg-6 col-xl-6 mb-3">
        <partial name="Components/_PieChart" model="Model.PieChart" />
    </div>
</div>

<div class="row h-48vh">
    <div class="col-12 col-xs-12 col-md-12 col-lg-6 col-xl-6 mb-3">
        <partial name="Components/_LineChart" model="Model.LineChart" />
    </div>
    <div class="col-12 col-xs-12 col-md-12 col-lg-6 col-xl-6 mb-3">
        <partial name="Components/_BarChart" model="Model.BarChart" />
    </div>
</div>

<script>
    $(document).ready(function () {
        function onSelectTicker(ticker) {
            // Bepaal huidige URL en parameter
            const url = new URL(window.location.href);
            const param = url.searchParams.get('tickers');

            // Helper voor case-insensitive check
            const norm = (s) => (s ?? '').trim().toLowerCase();

            // Is er precies één ticker geselecteerd en is dat dezelfde als 'ticker'?
            const isSingleSame =
                !!param &&
                param
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean).length === 1 &&
                norm(param) === norm(ticker);

            if (isSingleSame) {
                // Nogmaals klikken op dezelfde => reset naar "alles" (param verwijderen)
                url.searchParams.delete('tickers');
            } else {
                // Forceer filter op alleen deze ticker
                url.searchParams.set('tickers', ticker);
            }

            // Navigeer (laat overige params zoals 'year' intact)
            window.location.assign(url.toString());
        }

        // Exposeer globaal zodat de pie-chart ‘m kan aanroepen
        window.onSelectTicker = onSelectTicker;
    });
</script>
