@model Dashboard.Web.ViewModels.BarChartViewModel
@{
    var chartId = (string?)ViewData["ChartId"] ?? "chart_" + Guid.NewGuid().ToString("N");
}

<div class="card">
    @if (!string.IsNullOrEmpty(Model.Title))
    {
        <div class="card-header">@Model.Title</div>
    }
    <div class="card-body">
        <canvas id="@chartId" class="chart-canvas"></canvas>
    </div>
</div>

<script>
    $(document).ready(function() {
        var element = document.getElementById('@chartId');
        if (!element) return;
    
        // Chart data serializeren
        const chartData = @Html.Raw(JsonSerializer.Serialize(new {
            labels   = Model.DataPoints.Select(dp => dp.Label),
            datasets = new[] {
                new { 
                    label = Model.Title,
                    data = Model.DataPoints.Select(dp => dp.Value),
                }
            }
        })); 

        // Css variables ophalen
        chartData.datasets[0].backgroundColor = accentColors[0];

        const showAvg = @Html.Raw(JsonSerializer.Serialize(Model.ShowAverageLine));
        if (showAvg) {
            const values = chartData.datasets[0].data.map(Number).filter(v => Number.isFinite(v));
            const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;

            // Kies een nette kleur uit je palet (bijv. accent-4) of fallback
            const css = getComputedStyle(document.documentElement);
            const avgColor = (css.getPropertyValue('--accent-4') || '#666').trim();

            chartData.datasets.push({
                type: 'line',
                label: 'Average',
                data: chartData.labels.map(() => avg),
                borderColor: avgColor,
                borderWidth: 2,
                borderDash: [6, 4],
                pointRadius: 0,
                pointHitRadius: 0,
                tension: 0,
                fill: false,
                // Zorg dat de lijn boven de bars ligt
                order: 0
            });

            chartData._avgValue = avg;
        }

        new Chart(element, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: { 
                            label: (ctx) => formatY(ctx.parsed.y)
                        }
                    },
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { 
                        grid: { display: false },
                        ticks: { 
                            maxTicksLimit: 6,
                            callback: (value) => formatY(value)
                        },
                        afterDataLimits: (axis) => {
                            if (chartData._avgValue > axis.max) {
                                axis.max = chartData._avgValue * 1.1; // iets ruimte boven de lijn
                            }
                        },
                        afterBuildTicks: (axis) => {
                            if (!chartData._avgValue) return;
                            const ticks = axis.ticks.map(t => t.value);
                            if (!ticks.includes(chartData._avgValue)) {
                                axis.ticks.push({ value: chartData._avgValue });
                                axis.ticks.sort((a, b) => a.value - b.value);
                            }
                        }
                    }
                }
            }
        });
    });

    function formatY(v) {
        const yFormat = @Html.Raw(JsonSerializer.Serialize(Model.Format)); // "currency" | "percentage" | "number"
        const fmtCurrency = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtNumber = new Intl.NumberFormat('nl-NL', { maximumFractionDigits: 2 });

        if (yFormat === 'currency') return fmtCurrency.format(v);
        if (yFormat === 'percentage') return fmtNumber.format(v) + '%';
        return fmtNumber.format(v);
    }

</script>