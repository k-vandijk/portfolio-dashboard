@inject IStringLocalizer<SharedResource> SharedLocalizer
@using System.Globalization
@model List<Dashboard.Application.Dtos.TransactionDto>
@{
    var uniqueTickers = Model
        .Select(t => t.Ticker.Trim())
        .Where(t => !string.IsNullOrWhiteSpace(t))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(t => t)
        .ToList();

    var currentCulture = CultureInfo.CurrentUICulture.Name; // nl-NL | en-US
}

<datalist id="tickerList">
    @foreach (var t in uniqueTickers)
    {
        <option value="@t"></option>
    }
</datalist>

<div class="row mb-3 h-95vh">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive h-100">
                    <table id="transactionsTable" class="table table-hover table-sm table-transparent mb-0 w-100">
                        <thead>
                        <tr>
                            <th class="d-flex justify-content-center">#</th>
                            <th>@SharedLocalizer["Date"]</th>
                            <th>@SharedLocalizer["Ticker"]</th>
                            <th>@SharedLocalizer["Amount"]</th>
                            <th>@SharedLocalizer["PurchasePrice"]</th>
                            <th>@SharedLocalizer["TransactionCosts"]</th>
                            <th>@SharedLocalizer["TotalCosts"]</th>
                            <th class="text-center"><i class="fas fa-trash-alt"></i></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="text-center align-middle"><i class="fas fa-plus text-success"></i></td>
                            <td><input class="form-control form-control-sm" id="dateInput" type="text" /></td>
                            <td><input class="form-control form-control-sm" id="tickerInput" list="tickerList" autocomplete="off" /></td>
                            <td><input class="form-control form-control-sm" id="amountInput" /></td>
                            <td><input class="form-control form-control-sm" id="purchasePriceInput" /></td>
                            <td><input class="form-control form-control-sm" id="transactionCostsInput" /></td>
                            <td><input class="form-control form-control-sm" id="totalCostsInput" readonly /></td>
                            <td></td>
                        </tr>
                        @for (int i = Model.Count - 1; i >= 0; i--)
                        {
                            <tr>
                                <td class="d-flex justify-content-center">@(i + 1)</td>
                                <td>@Model[i].Date.ToString("yyyy-MM-dd")</td>
                                <td>@Model[i].Ticker</td>
                                <td class="text-end">@Model[i].Amount</td>
                                <td class="text-end">@Model[i].PurchasePrice.ToString("C2")</td>
                                <td class="text-end">@Model[i].TransactionCosts.ToString("C2")</td>
                                <td class="text-end fw-bold">
                                    <span class="@(Model[i].TotalCosts >= 0 ? "text-success" : "text-danger")">
                                        @Model[i].TotalCosts.ToString("C2")
                                    </span>
                                </td>
                                    <td class="d-flex align-items-center justify-content-center">
                                    <button class="btn btn-outline-danger btn-sm rounded-circle p-0 d-flex align-items-center justify-content-center icon-sm"
                                            onclick="postDeleteTransaction('@Model[i].RowKey')">
                                        <i class="fas fa-minus fa-xs"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        var dtLanguage = {
          paginate: {
            previous: '<i class="fa-solid fa-angle-left" aria-hidden="true"></i>',
            next: '<i class="fa-solid fa-angle-right" aria-hidden="true"></i>'
          }
        };

        // Only try to load external language file if we have a URL
        // Using async: false is deprecated, so we'll initialize without external language file
        // and use inline translations instead
        var currentCulture = '@currentCulture';
        if (currentCulture === 'nl-NL') {
            dtLanguage = {
                paginate: {
                    previous: '<i class="fa-solid fa-angle-left" aria-hidden="true"></i>',
                    next: '<i class="fa-solid fa-angle-right" aria-hidden="true"></i>',
                    first: 'Eerste',
                    last: 'Laatste'
                },
                emptyTable: 'Geen gegevens beschikbaar in tabel',
                info: '_START_ tot _END_ van _TOTAL_ resultaten',
                infoEmpty: '0 tot 0 van 0 resultaten',
                infoFiltered: ' (gefilterd uit _MAX_ resultaten)',
                lengthMenu: '_MENU_ resultaten weergeven',
                loadingRecords: 'Laden...',
                processing: 'Bezig...',
                search: 'Zoeken:',
                zeroRecords: 'Geen resultaten gevonden'
            };
        }

        $('#transactionsTable').DataTable({
            paging: true,
            searching: false,
            ordering: false,
            pageLength: 25,
            lengthChange: false,
            order: [[0, 'desc']],
            language: dtLanguage,
            layout: {
                topStart: null,
                topEnd: null
            }
        });

        // Set event listeners on the number inputs to update the totals
        ['amountInput', 'purchasePriceInput', 'transactionCostsInput'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('keyup', calcTotal);
        });

        // Set event listeners on all inputs (except the totalCostsInput) to listen for 'enter' to post the data
        ['tickerInput', 'amountInput', 'purchasePriceInput', 'transactionCostsInput', 'totalCostsInput']
            .forEach(id => {
                document.getElementById(id).addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const entity = buildEntity();

                        postAddTransaction(entity);
                    }
                });
            });

        flatpickr("#dateInput", {
            dateFormat: "Y-m-d",
            allowInput: true,
            clickOpens: true,
            disableMobile: true,
        });
    });

    function calcTotal() {
        const amount = parseDecimal(document.getElementById('amountInput').value) || 0;
        const price = parseDecimal(document.getElementById('purchasePriceInput').value) || 0;
        const costs = parseDecimal(document.getElementById('transactionCostsInput').value) || 0;

        const total = amount * price + costs;
        document.getElementById('totalCostsInput').value = total.toLocaleString('nl-NL', {
            style: 'currency',
            currency: 'EUR'
        });
        return total;
    }

    function buildEntity() {
        const entity = {
            Date: document.getElementById('dateInput').value || null,
            Ticker: (document.getElementById('tickerInput').value || '').trim() || null,
            Amount: parseDecimal(document.getElementById('amountInput').value) || 0,
            PurchasePrice: parseDecimal(document.getElementById('purchasePriceInput').value) || 0,
            TransactionCosts: parseDecimal(document.getElementById('transactionCostsInput').value) || 0,
        };

        return entity;
    }

    function clearInputs() {
        ['dateInput','tickerInput','amountInput','purchasePriceInput','transactionCostsInput','totalCostsInput']
            .forEach(id => document.getElementById(id).value = '');
    }

    function parseDecimal(value) {
        return parseFloat(value.replace(',', '.'));
    }

    function postAddTransaction(transaction) {
        fetch('@Url.Action("AddTransaction", "Transactions")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transaction)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }

            clearInputs();
            location.reload();
        })
        .catch(error => {
            showAlert('error', 'Error adding transaction.');
        });
    }

    function postDeleteTransaction(rowKey) {
        showConfirmationDialog('Are you sure you want to delete this transaction?', function() {
            fetch('@Url.Action("DeleteTransaction", "Transactions")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rowKey)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }

                location.reload();
            })
            .catch(error => {
                showAlert('error', 'Error deleting transaction.');
            });
        });
    }
</script>